<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>爆款文案生成 - AI智能助手</title>
    <style>
        /* 基本页面样式，不干扰Coze原生样式 */
        body {
            margin: 0;
            padding: 0;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'PingFang SC', 'Hiragino Sans GB', 
                         'Microsoft YaHei', 'Helvetica Neue', Helvetica, Arial, sans-serif;
        }
    </style>
</head>
<body>
    <script type="text/javascript">
        // 抑制 Coze SDK 内部的 ErrorBoundary 警告（不影响功能）
        (function() {
            // 检查消息是否包含 ErrorBoundary 警告
            function shouldFilterMessage(args) {
                var message = '';
                for (var i = 0; i < args.length; i++) {
                    if (typeof args[i] === 'string') {
                        message += args[i] + ' ';
                    } else if (args[i] && typeof args[i] === 'object') {
                        // 检查对象中的 message 属性
                        if (args[i].message) {
                            message += args[i].message + ' ';
                        }
                        // 检查对象转换为字符串
                        try {
                            message += JSON.stringify(args[i]) + ' ';
                        } catch (e) {}
                    }
                }
                message = message.toLowerCase();
                // 过滤 ErrorBoundary 相关的警告
                return (message.indexOf('errorboundary') >= 0 && 
                        message.indexOf('not found logger instance') >= 0) ||
                       (message.indexOf('errorboundary') >= 0 && 
                        message.indexOf('chat-message-box-children') >= 0);
            }
            
            // 过滤 console.error
            var originalError = console.error;
            console.error = function() {
                if (!shouldFilterMessage(arguments)) {
                    originalError.apply(console, arguments);
                }
            };
            
            // 过滤 console.warn
            var originalWarn = console.warn;
            console.warn = function() {
                if (!shouldFilterMessage(arguments)) {
                    originalWarn.apply(console, arguments);
                }
            };
        })();
        
        // 加载 JWT 签名库（用于生成 OAuth JWT Token）
        var jwtScript = document.createElement('script');
        jwtScript.src = 'https://cdn.jsdelivr.net/npm/jsrsasign@10.5.25/lib/jsrsasign-all-min.js';
        document.head.appendChild(jwtScript);
        
        var webSdkScript = document.createElement('script');
        webSdkScript.src = 'https://lf-cdn.coze.cn/obj/unpkg/flow-platform/chat-app-sdk/1.2.0-beta.19/libs/cn/index.js';
        document.head.appendChild(webSdkScript);

        // 等待 JWT 库和 Coze SDK 都加载完成
        var jwtLoaded = false;
        var sdkLoaded = false;
        
        jwtScript.onload = function() {
            jwtLoaded = true;
            if (sdkLoaded) {
                initCozeSDK();
            }
        };
        
        webSdkScript.onload = function () {
            sdkLoaded = true;
            if (jwtLoaded || typeof KJUR === 'undefined') {
                // 如果 JWT 库未加载，尝试直接初始化（使用 SAT 方式）
                initCozeSDK();
            }
        };
        
        function initCozeSDK() {
            // OAuth JWT 配置（需要在 Coze 平台创建 OAuth 应用后获取）
            // 请替换为您的 OAuth 应用配置
            const oauthConfig = {
                appId: '', // OAuth 应用 ID
                publicKey: '', // 公钥 (kid)
                privateKey: '' // 私钥 (PEM 格式)
            };
            
            // 服务访问令牌（SAT）- 作为备用方案
            const serviceToken = 'sat_fz8c5xpgM0GIUWMSVnbIo5LNatLyL9InvnXjkBnJfmngNYwjOX8zmgCdEXEaLot6';
            
            // 为每个设备生成唯一的设备ID（存储在localStorage，不清除）
            function getOrCreateDeviceId() {
                const deviceIdKey = 'coze_device_id';
                let deviceId = localStorage.getItem(deviceIdKey);
                if (!deviceId) {
                    // 生成设备ID：时间戳 + 随机数（简化版本）
                    deviceId = 'device_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
                    localStorage.setItem(deviceIdKey, deviceId);
                }
                return deviceId;
            }
            
            // 生成 OAuth JWT Token（用于会话隔离）
            function generateJWTToken(deviceId) {
                // 如果未配置 OAuth，使用 SAT 方式
                if (!oauthConfig.appId || !oauthConfig.privateKey) {
                    return null;
                }
                
                try {
                    // 使用 jsrsasign 库生成 JWT
                    const header = {
                        alg: 'RS256',
                        typ: 'JWT',
                        kid: oauthConfig.publicKey
                    };
                    
                    const now = Math.floor(Date.now() / 1000);
                    const payload = {
                        iss: oauthConfig.appId,
                        aud: 'api.coze.cn',
                        iat: now,
                        exp: now + 86400, // 24小时过期
                        jti: 'jti_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9),
                        session_name: deviceId // 关键：使用设备ID作为 session_name，实现会话隔离
                    };
                    
                    const sHeader = JSON.stringify(header);
                    const sPayload = JSON.stringify(payload);
                    const sJWT = KJUR.jws.JWS.sign('RS256', sHeader, sPayload, oauthConfig.privateKey);
                    
                    return sJWT;
                } catch (e) {
                    console.error('生成 JWT Token 失败:', e);
                    return null;
                }
            }
            
            // 获取 Access Token（使用 JWT）
            async function getAccessToken(deviceId) {
                const jwtToken = generateJWTToken(deviceId);
                if (!jwtToken) {
                    // 如果无法生成 JWT，返回 SAT 作为备用
                    return serviceToken;
                }
                
                try {
                    const response = await fetch('https://api.coze.cn/api/permission/oauth2/token', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': 'Bearer ' + jwtToken
                        },
                        body: JSON.stringify({
                            duration_seconds: 86399,
                            grant_type: 'urn:ietf:params:oauth:grant-type:jwt-bearer'
                        })
                    });
                    
                    if (response.ok) {
                        const data = await response.json();
                        return data.access_token || serviceToken;
                    } else {
                        console.error('获取 Access Token 失败:', response.status);
                        return serviceToken;
                    }
                } catch (e) {
                    console.error('获取 Access Token 出错:', e);
                    return serviceToken;
                }
            }
            
            // 清除会话相关的缓存，但保留设备ID
            try {
                // 清除localStorage中所有Coze相关的数据（但保留设备ID）
                const localStorageKeys = Object.keys(localStorage);
                localStorageKeys.forEach(key => {
                    if (key && key !== 'coze_device_id' && (
                        key.toLowerCase().indexOf('coze') >= 0 || 
                        key.toLowerCase().indexOf('session') >= 0 || 
                        key.toLowerCase().indexOf('chat') >= 0 ||
                        key.toLowerCase().indexOf('7576948828981608511') >= 0 || // App ID
                        key.toLowerCase().indexOf('7577062163073941540') >= 0     // Workflow ID
                    )) {
                        localStorage.removeItem(key);
                    }
                });
                
                // 清除sessionStorage中所有Coze相关的数据
                const sessionStorageKeys = Object.keys(sessionStorage);
                sessionStorageKeys.forEach(key => {
                    if (key && (
                        key.toLowerCase().indexOf('coze') >= 0 || 
                        key.toLowerCase().indexOf('session') >= 0 || 
                        key.toLowerCase().indexOf('chat') >= 0 ||
                        key.toLowerCase().indexOf('7576948828981608511') >= 0 ||
                        key.toLowerCase().indexOf('7577062163073941540') >= 0
                    )) {
                        sessionStorage.removeItem(key);
                    }
                });
                
                // 清除IndexedDB（如果存在）
                if ('indexedDB' in window) {
                    indexedDB.databases().then(databases => {
                        databases.forEach(db => {
                            if (db.name && (
                                db.name.toLowerCase().indexOf('coze') >= 0 ||
                                db.name.toLowerCase().indexOf('session') >= 0 ||
                                db.name.toLowerCase().indexOf('chat') >= 0 ||
                                db.name.toLowerCase().indexOf('7576948828981608511') >= 0 ||
                                db.name.toLowerCase().indexOf('7577062163073941540') >= 0
                            )) {
                                indexedDB.deleteDatabase(db.name);
                            }
                        });
                    }).catch(() => {});
                }
            } catch (e) {
                console.log('清除缓存时出错（可忽略）:', e);
            }
            
            // 生成新的会话ID，每次刷新页面时都会生成新的
            function generateSessionId() {
                const timestamp = Date.now();
                const random1 = Math.random().toString(36).substr(2, 9);
                const random2 = Math.random().toString(36).substr(2, 9);
                return 'session_' + timestamp + '_' + random1 + '_' + random2;
            }
            
            // 初始化 Coze SDK（异步，因为需要获取 Access Token）
            (async function() {
                try {
                    // 获取或创建设备ID（每个设备唯一，持久化存储）
                    const deviceId = getOrCreateDeviceId();
                    console.log('设备ID:', deviceId);
                    
                    // 生成新的会话ID（在初始化之前）
                    const newSessionId = generateSessionId();
                    console.log('新会话ID:', newSessionId);
                    
                    // 获取 Access Token（使用 JWT 实现会话隔离）
                    const accessToken = await getAccessToken(deviceId);
                    console.log('使用 OAuth JWT 方式:', accessToken !== serviceToken);
                    
                    // 使用默认的悬浮按钮模式，不指定container
                    const chatClient = new CozeWebSDK.WebChatClient({
                        "config": {
                            "type": "app",
                            "appInfo": {
                                "appId": "7576948828981608511",
                                "workflowId": "7577062163073941540"
                            },
                            // 每次刷新页面时生成新的会话ID
                            "sessionId": newSessionId,
                            // 禁用历史记录，确保每次都是新会话
                            "enableHistory": false
                        },
                        "auth": {
                            "type": "token",
                            "token": accessToken,
                            onRefreshToken: async function () {
                                // 刷新 Token 时重新获取（使用相同的设备ID）
                                return await getAccessToken(deviceId);
                            }
                        },
                        // 用户信息
                        "userInfo": {
                            "id": deviceId,
                            "nickname": "访客"
                        }
                        // 不指定container，使用默认的悬浮按钮模式
                    });
                
                // 全局保存 chatClient 引用，方便调试
                window.cozeChatClient = chatClient;
                
                // 自动打开对话框的函数（简化版本，避免干扰）
                function autoOpenDialog() {
                    try {
                        // 方法1: 优先使用官方推荐的 showChatBot 方法
                        if (chatClient && typeof chatClient.showChatBot === 'function') {
                            chatClient.showChatBot();
                            return true;
                        }
                        
                        // 方法2: 尝试调用 open 方法
                        if (chatClient && typeof chatClient.open === 'function') {
                            chatClient.open();
                            return true;
                        }
                    } catch (e) {
                        // 静默处理错误，不输出日志避免干扰
                    }
                    return false;
                }
                
                // 监听 ready 事件
                if (chatClient && typeof chatClient.on === 'function') {
                    chatClient.on('ready', function() {
                        // 延迟后尝试打开
                        setTimeout(autoOpenDialog, 500);
                    });
                }
                
                    // 多次尝试打开（防止 ready 事件未触发）
                    setTimeout(autoOpenDialog, 1000);
                    setTimeout(autoOpenDialog, 2000);
                    setTimeout(autoOpenDialog, 3000);
                    
                } catch (error) {
                    console.error('Coze SDK 初始化错误:', error);
                    // 移除错误处理，避免页面被替换
                }
            })();
        };

        // 错误处理（移除页面替换逻辑）
        webSdkScript.onerror = function () {
            console.error('Failed to load Coze Web SDK');
            // 移除错误处理，避免页面被替换
        };
    </script>
</body>
</html>
