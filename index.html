<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>爆款文案生成 - AI智能助手</title>
    <style>
        /* 基本页面样式，不干扰Coze原生样式 */
        body {
            margin: 0;
            padding: 0;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'PingFang SC', 'Hiragino Sans GB', 
                         'Microsoft YaHei', 'Helvetica Neue', Helvetica, Arial, sans-serif;
        }
    </style>
</head>
<body>
    <script type="text/javascript">
        var webSdkScript = document.createElement('script');
        webSdkScript.src = 'https://lf-cdn.coze.cn/obj/unpkg/flow-platform/chat-app-sdk/1.2.0-beta.19/libs/cn/index.js';
        document.head.appendChild(webSdkScript);

        webSdkScript.onload = function () {
            // 服务访问令牌（SAT）
            const serviceToken = 'sat_fz8c5xpgM0GIUWMSVnbIo5LNatLyL9InvnXjkBnJfmngNYwjOX8zmgCdEXEaLot6';
            
            // 清除所有可能存在的会话缓存，确保每次都是新会话
            try {
                // 清除localStorage中所有Coze相关的数据
                const localStorageKeys = Object.keys(localStorage);
                localStorageKeys.forEach(key => {
                    if (key && (
                        key.toLowerCase().indexOf('coze') >= 0 || 
                        key.toLowerCase().indexOf('session') >= 0 || 
                        key.toLowerCase().indexOf('chat') >= 0 ||
                        key.toLowerCase().indexOf('7576948828981608511') >= 0 || // App ID
                        key.toLowerCase().indexOf('7577062163073941540') >= 0     // Workflow ID
                    )) {
                        localStorage.removeItem(key);
                    }
                });
                
                // 清除sessionStorage中所有Coze相关的数据
                const sessionStorageKeys = Object.keys(sessionStorage);
                sessionStorageKeys.forEach(key => {
                    if (key && (
                        key.toLowerCase().indexOf('coze') >= 0 || 
                        key.toLowerCase().indexOf('session') >= 0 || 
                        key.toLowerCase().indexOf('chat') >= 0 ||
                        key.toLowerCase().indexOf('7576948828981608511') >= 0 ||
                        key.toLowerCase().indexOf('7577062163073941540') >= 0
                    )) {
                        sessionStorage.removeItem(key);
                    }
                });
                
                // 清除IndexedDB（如果存在）
                if ('indexedDB' in window) {
                    indexedDB.databases().then(databases => {
                        databases.forEach(db => {
                            if (db.name && (
                                db.name.toLowerCase().indexOf('coze') >= 0 ||
                                db.name.toLowerCase().indexOf('session') >= 0 ||
                                db.name.toLowerCase().indexOf('chat') >= 0 ||
                                db.name.toLowerCase().indexOf('7576948828981608511') >= 0 ||
                                db.name.toLowerCase().indexOf('7577062163073941540') >= 0
                            )) {
                                indexedDB.deleteDatabase(db.name);
                            }
                        });
                    }).catch(() => {});
                }
            } catch (e) {
                console.log('清除缓存时出错（可忽略）:', e);
            }
            
            // 生成新的会话ID，每次刷新页面时都会生成新的
            function generateSessionId() {
                const timestamp = Date.now();
                const random1 = Math.random().toString(36).substr(2, 9);
                const random2 = Math.random().toString(36).substr(2, 9);
                return 'session_' + timestamp + '_' + random1 + '_' + random2;
            }
            
            try {
                // 生成新的会话ID（在初始化之前）
                const newSessionId = generateSessionId();
                console.log('新会话ID:', newSessionId);
                
                // 生成唯一的用户ID（每次访问都不同，确保新会话）
                const uniqueUserId = 'user_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
                
                // 使用默认的悬浮按钮模式，不指定container
                const chatClient = new CozeWebSDK.WebChatClient({
                    "config": {
                        "type": "app",
                        "appInfo": {
                            "appId": "7576948828981608511",
                            "workflowId": "7577062163073941540"
                        },
                        // 每次刷新页面时生成新的会话ID
                        "sessionId": newSessionId,
                        // 禁用历史记录，确保每次都是新会话
                        "enableHistory": false
                    },
                    "auth": {
                        "type": "token",
                        "token": serviceToken,
                        onRefreshToken: function () {
                            // 返回相同的服务访问令牌
                            return serviceToken;
                        }
                    },
                    // 用户信息：每次生成新的用户ID，确保不同会话
                    "userInfo": {
                        "id": uniqueUserId,
                        "nickname": "访客"
                    }
                    // 不指定container，使用默认的悬浮按钮模式
                });
                
                // 全局保存 chatClient 引用，方便调试
                window.cozeChatClient = chatClient;
                
                // 自动打开对话框的函数
                function autoOpenDialog() {
                    try {
                        // 方法1: 尝试调用 open 方法
                        if (chatClient && typeof chatClient.open === 'function') {
                            chatClient.open();
                            console.log('已调用 open() 方法');
                            return true;
                        }
                        
                        // 方法2: 查找并点击悬浮按钮
                        var buttons = document.querySelectorAll('button, div[role="button"], [class*="button"], [class*="btn"], [style*="position: fixed"]');
                        for (var i = 0; i < buttons.length; i++) {
                            var btn = buttons[i];
                            var style = window.getComputedStyle(btn);
                            var rect = btn.getBoundingClientRect();
                            
                            // 检查是否是右下角的悬浮按钮（固定定位，在右下角区域）
                            if (style.position === 'fixed' && 
                                rect.right > window.innerWidth - 100 && 
                                rect.bottom > window.innerHeight - 100 &&
                                rect.width > 40 && rect.width < 100 &&
                                rect.height > 40 && rect.height < 100) {
                                btn.click();
                                console.log('已点击悬浮按钮');
                                return true;
                            }
                        }
                        
                        // 方法3: 查找包含 Coze logo 的元素并点击
                        var cozeElements = document.querySelectorAll('[class*="coze"], [id*="coze"]');
                        for (var j = 0; j < cozeElements.length; j++) {
                            var elem = cozeElements[j];
                            var elemStyle = window.getComputedStyle(elem);
                            var elemRect = elem.getBoundingClientRect();
                            
                            // 如果是固定定位且在右下角，尝试点击
                            if (elemStyle.position === 'fixed' && 
                                elemRect.right > window.innerWidth - 150 && 
                                elemRect.bottom > window.innerHeight - 150) {
                                elem.click();
                                console.log('已点击 Coze 元素');
                                return true;
                            }
                        }
                    } catch (e) {
                        console.error('自动打开对话框时出错:', e);
                    }
                    return false;
                }
                
                // 监听 ready 事件
                if (chatClient && typeof chatClient.on === 'function') {
                    chatClient.on('ready', function() {
                        console.log('SDK ready 事件触发');
                        // 延迟后尝试打开
                        setTimeout(autoOpenDialog, 500);
                    });
                }
                
                // 多次尝试打开（防止 ready 事件未触发）
                setTimeout(autoOpenDialog, 1000);
                setTimeout(autoOpenDialog, 2000);
                setTimeout(autoOpenDialog, 3000);
                setTimeout(autoOpenDialog, 4000);
                setTimeout(autoOpenDialog, 5000);
                
                // 自定义UI：修改占位符文本和隐藏横幅
                function customizeUI() {
                    try {
                        // 1. 修改输入框占位符文本：将"chatinputplaceholder"改为"请输入主题或链接"
                        
                        // 方法1: 修改 placeholder 属性（只查找Coze相关的元素，提高性能）
                        var inputs = document.querySelectorAll('[class*="coze"] input[type="text"], [class*="coze"] textarea, [class*="coze"] [contenteditable="true"], [class*="coze"] [contenteditable], [id*="coze"] input[type="text"], [id*="coze"] textarea, [id*="coze"] [contenteditable="true"], [id*="coze"] [contenteditable]');
                        inputs.forEach(function(input) {
                            if (input.placeholder && input.placeholder.toLowerCase().indexOf('chatinputplaceholder') >= 0) {
                                input.placeholder = '请输入主题或链接';
                            }
                            // 检查 data-placeholder 属性
                            if (input.getAttribute('data-placeholder') && 
                                input.getAttribute('data-placeholder').toLowerCase().indexOf('chatinputplaceholder') >= 0) {
                                input.setAttribute('data-placeholder', '请输入主题或链接');
                            }
                        });
                        
                        // 方法2: 查找包含占位符文本的 div 元素（只查找Coze相关的元素）
                        var cozeElements = document.querySelectorAll('[class*="coze"] *, [id*="coze"] *');
                        cozeElements.forEach(function(el) {
                            // 跳过输入框本身
                            if (el.tagName === 'INPUT' || el.tagName === 'TEXTAREA' || el.hasAttribute('contenteditable')) {
                                return;
                            }
                            
                            var text = (el.textContent || el.innerText || '').trim();
                            // 如果是占位符文本，替换它
                            if (text.toLowerCase() === 'chatinputplaceholder' || 
                                text.toLowerCase().indexOf('chatinputplaceholder') >= 0) {
                                // 检查是否是占位符元素（通常是空的或只有占位符文本，且是叶子节点）
                                if (el.children.length === 0 || 
                                    (el.children.length === 1 && el.children[0].textContent.trim() === '')) {
                                    el.textContent = '请输入主题或链接';
                                }
                            }
                            
                            // 2. 隐藏 "web_sdk_official_banner" 文本
                            if (text.toLowerCase() === 'web_sdk_official_banner' || 
                                text.toLowerCase().indexOf('web_sdk_official_banner') >= 0) {
                                el.style.display = 'none';
                                el.style.visibility = 'hidden';
                                el.style.opacity = '0';
                                el.style.height = '0';
                                el.style.width = '0';
                                el.style.overflow = 'hidden';
                                el.style.margin = '0';
                                el.style.padding = '0';
                            }
                        });
                    } catch (e) {
                        // 静默处理错误，不影响对话框打开
                    }
                }
                
                // 使用 DOM 观察器检测悬浮按钮出现后自动点击，并修改UI
                var opened = false;
                var observer = new MutationObserver(function(mutations) {
                    // 优先尝试打开对话框
                    if (!opened) {
                        opened = autoOpenDialog();
                    }
                    // 然后修改UI（延迟执行，避免影响对话框打开）
                    setTimeout(customizeUI, 100);
                });
                
                observer.observe(document.body, {
                    childList: true,
                    subtree: true,
                    attributes: true,
                    attributeFilter: ['class', 'style', 'placeholder']
                });
                
                // 定期执行UI自定义（确保能捕获到动态生成的元素）
                var customizeInterval = setInterval(function() {
                    customizeUI();
                }, 1000);
                
                // 15秒后停止观察和定时器
                setTimeout(function() {
                    observer.disconnect();
                    clearInterval(customizeInterval);
                }, 15000);
                
            } catch (error) {
                console.error('Coze SDK 初始化错误:', error);
                document.body.innerHTML = '<div style="padding: 40px; text-align: center; color: #e74c3c;">初始化失败，请检查配置</div>';
            }
        };

        // 错误处理
        webSdkScript.onerror = function () {
            console.error('Failed to load Coze Web SDK');
            document.body.innerHTML = '<div style="padding: 40px; text-align: center; color: #e74c3c;">加载失败，请刷新页面重试</div>';
        };
    </script>
</body>
</html>
